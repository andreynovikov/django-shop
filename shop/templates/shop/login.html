{% extends "shop/base.html" %}
{% block title %}Добро пожаловать{% endblock %}
{% block css %}
<style type="text/css">
	.sw-phone-input          { height:auto; color: black; }
	.sw-phone-input:-moz-placeholder { color:#e0e0e0; }
	.sw-phone-input::-webkit-input-placeholder { color:#e0e0e0; }
	.sw-small-jumbotron      { font-size:10pt; }
        #login-form { background-color: inherit; }
</style>
{% endblock %}

{% block content %}
{% load staticfiles %}
{% load shop_filters %}
<h1>Кабинет покупателя</h1>
{% if next %}
    {% if user.is_authenticated %}
    <p>У вас нет права доступа к этой странице.</p>
    {% else %}
    <!-- <p>Пожалуйста, авторизуйтесь, чтобы увидеть эту страницу.</p> -->
    {% endif %}
{% endif %}
<form id="login-form" class="form-inline jumbotron{% if wrong_password %} has-error{% endif %}" action="{% url 'shop:login' %}" method="post">
    {% csrf_token %}
    <input type="hidden" name="next" value="{{ next|default_if_none:"" }}"/>
    {% if shop_user %}
        {# Пользователь с таким телефоном уже есть #}
        <input type="hidden" name="phone" id="phone-input" value="{{ phone }}"/>
        {# Требуем подтверждение пароля #}
        <p>{{ shop_user.phone|format_phone }}</p>
        <label class="control-label lead" for="password-input">Пароль:</label>
        <input type="password" class="form-control input-lg" name="password" id="password-input" value="" size="20"/>
        {% if wrong_password %}
        <span id="password-help" class="help-block">Вы ввели неправильный пароль</span>
        {% else %}
        <span id="password-help" class="help-block">Пароль выслан на указанный телефон по смс</span>
        {% endif %}
        <p><a href="{% url 'shop:reset_password' %}" id="reset-password" class="ajax sw-small-jumbotron hide">Прислать пароль повторно</a></p>
    {% else %}
        {# Анонимный пользователь #}
        <p><label class="control-label lead" for="phone-input">Укажите номер мобильного телефона:</label>
        <div id="phone-block" class="input-group">
            <span class="input-group-addon input-lg sw-phone-input">+7</span>
            <input type="tel" class="form-control input-lg sw-phone-input" name="phone" id="phone-input" value="" size="20" placeholder="(999) 111-22-33"/>
        </div>
    {% endif %}
    <input type="submit" id="login-submit" class="btn btn-success btn-lg" value="Продолжить"/>
    {% if error %}
    <div class="has-error"><span id="error" class="help-block">{{ error }}</span></div>
    {% endif %}
</form>
{% endblock %}

{% block javascript %}
    <script type="text/javascript">
        $(document).ready(function () {
            var CustomHandlers = function () {
            };
            CustomHandlers.prototype.passwordResetBegin = function (e, $el) {
                $el.on("eldarion-ajax:modify-data", function (e, data) {
                    encphone = encodeURIComponent($("#phone-input").val());
                    if (typeof data === "object") { // using FormData
                        data.append("ajax", 1);
                        data.append("phone", encphone);
                    } else if (data != null)
                        data = data + "&ajax=1&phone=" + encphone;
                    else
                        data = "ajax=1&phone=" + encphone;
                    return data;
                });
            };
            CustomHandlers.prototype.passwordReset = function (e, $el) {
                $("#password-help").text("Новый пароль выслан на указанный телефон");
                $("#password-help").removeClass("hide").show();
                $("#reset-password").addClass("hide").hide();
                $("#login-form").addClass("has-warning");
                delayShowPasswordReset();
            };
            $(document).on("eldarion-ajax:begin", function(evt, $el) {
                $("body").css("cursor", "progress");
            });
            $(document).on("eldarion-ajax:complete", function(evt, $el) {
                $("body").css("cursor", "auto");
            });
            $(document).on("eldarion-ajax:begin",   "#reset-password", CustomHandlers.prototype.passwordResetBegin);
            $(document).on("eldarion-ajax:success", "#reset-password", CustomHandlers.prototype.passwordReset);

            initHandlers();
        });

        function initHandlers() {
            $("#login-submit").prop("disabled", true);

            $("#login-form").on("submit", function() {
                 var complete = $("#phone-input").inputmask("isComplete");
                 if (!complete)
                     $("#phone-block").addClass("has-error");
                 return complete;
            });

            $("#password-input").inputmask({
                mask: ["9999", "*{5,30}"],
                placeholder: "",
                oncomplete: function() {
                    $("#login-submit").prop("disabled", false);
                }
            });
            $("#password-input").on("paste keydown", function () {
                $("#login-form").removeClass("has-error");
                $("#login-form").removeClass("has-warning");
                $("#password-help").hide();
                $("#password-help").text("");
            });

            // https://github.com/RobinHerbots/Inputmask
            $("#phone-input").inputmask({
                mask: ["(999) 999-99-99", "* (999) 999-99-99"],
                definitions: {
                    "*": { validator: "[78]" }
                },
                onBeforePaste: function(pastedValue, opts) {
                    return pastedValue.replace("+7", "");
                },
                onBeforeMask: function(value, opts) {
                    return value.replace("+7", "");
                },
                oncomplete: function() {
                    $("#phone-block").removeClass("has-error");
                    var value = this.inputmask.unmaskedvalue();
                    if (value.length > 10) {
                        value = value.substr(1);
                        this.inputmask.setValue(value);
                    }
                    $("#login-submit").prop("disabled", false);
                },
                keepStatic: true
            });

            delayShowPasswordReset();
        }

        function delayShowPasswordReset() {
            setTimeout(function() {
                $("#reset-password").removeClass("hide").show();
            }, 5000);
        }
    </script>
{% endblock %}
