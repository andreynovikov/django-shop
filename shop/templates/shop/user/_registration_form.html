<form id="sw-reg-form" class="needs-validation{% if error %} was-validated{% endif %}" novalidate action="{% url 'shop:register' %}" method="post">
  {% csrf_token %}
  <input type="hidden" name="next" value="{{ next|default_if_none:"" }}"/>
  <div class="form-group">
    <label for="reg-phone-input">Укажите номер мобильного телефона:</label>
    <div class="input-group">
      <div class="input-group-prepend">
        <span class="input-group-text bg-secondary">+7</span>
      </div>
      <input class="form-control" type="tel" name="phone" id="reg-phone-input" value="{{ phone }}" placeholder="(999) 111-22-33" autocomplete="phone" required/>
      <div class="invalid-feedback" id="reg-phone-input-error">{{ error }}</div>
    </div>
  </div>
  <div class="form-group">
    <label for="email-input">Адрес электронной почты:</label>
    <input type="email" class="form-control" name="email" id="email-input" value="{{ email }}" autocomplete="email"/>
    <small class="form-text text-muted">опционально</small>
  </div>
  <div class="form-group">
    <label for="name-input">Фамилия Имя Отчество:</label>
    <input type="text" class="form-control" name="name" id="name-input" value="{{ name }}" autocomplete="name"/>
    <small class="form-text text-muted">если Вы планируете оформлять заказы</small>
  </div>
  <div class="form-group">
    <label for="username-input">Псевдоним для форума:</label>
    <input type="text" class="form-control" name="username" id="username-input" value="{{ username }}"/>
    <small class="form-text text-muted">если Вы не хотите, чтобы Ваше настоящее имя отображалось в форуме</small>
  </div>
  <div class="text-right">
    <button class="btn btn-primary" type="submit">{% if not embedded %}<i class="czi-user mr-2 ml-n1"></i>{% endif %}Зарегистрироваться</button>
  </div>
</form>
<script type="text/javascript">
(function() {
    'use strict';
    var initializeRegistrationForm = function() {
        var phoneInput = document.getElementById("reg-phone-input");
        var phoneInputError = document.getElementById("reg-phone-input-error");

        phoneInput.setCustomValidity("{{ error }}");

        // https://github.com/RobinHerbots/Inputmask
        Inputmask({
            mask: ["(999) 999-99-99", "* (999) 999-99-99"],
            definitions: {
                "*": { validator: "[78]" }
            },
            onBeforePaste: function(pastedValue, opts) {
                return pastedValue.replace("+7", "");
            },
            onBeforeMask: function(value, opts) {
                return value.replace("+7", "");
            },
            oncomplete: function() {
                var value = this.inputmask.unmaskedvalue();
                if (value.length > 10) {
                    value = value.substr(1);
                    this.inputmask.setValue(value);
                }
                phoneInput.setCustomValidity("");
            },
            keepStatic: true
        }).mask(phoneInput);

        phoneInput.addEventListener("input", function (event) {
            if (phoneInput.inputmask.isComplete()) {
                phoneInput.setCustomValidity("");
            } else {
                phoneInputError.textContent = "Введите корректный номер";
                phoneInput.setCustomValidity(phoneInputError.textContent);
            }
        });
    };

    // Check if form is included via Ajax or put directly on page
    if (typeof Inputmask === "function")
        initializeRegistrationForm()
    else
        window.addEventListener('load', initializeRegistrationForm, false);

    var form = document.getElementById("sw-reg-form");
    form.addEventListener("submit", function(event) {
        if (form.checkValidity() === false) {
            event.preventDefault();
            event.stopPropagation();
            event.stopImmediatePropagation();
            form.classList.add("was-validated");
        }
    }, false);
})();
</script>
