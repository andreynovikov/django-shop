{% extends "shop/user/page.html" %}
{% load decimals %}
{% load django_bootstrap_breadcrumbs %}
{% load thumbnail %}
{% load shop_filters %}
{% block title %}Избранное{% endblock %}
{% block content_title %}Моё избранное{% endblock %}
{% block breadcrumbs %}
    {{ block.super }}
    {% breadcrumb 'Избранное' '' %}
{% endblock %}
{% block toolbar %}
          <div class="d-none d-lg-flex justify-content-between align-items-center pt-lg-3 pb-4 pb-lg-5 mb-lg-4">
            <div class="d-flex w-100 text-light text-center mr-3"></div>
            {{ block.super }}
          </div>
{% endblock %}
{% block user_content %}
          <div class="favorite-list">
            {% for product in favorites %}
            <div class="d-sm-flex justify-content-between {% if forloop.first %}mt-lg-4 mb-4{% else %}my-4{% endif %}{% if not forloop.last %} pb-3 pb-sm-2 border-bottom{% endif %} favorites-item">
              <div class="media media-ie-fix d-block d-sm-flex align-items-center text-center text-sm-left"><a class="d-inline-block mx-auto mr-sm-4" href="{% url 'product' product.code %}" style="width: 10rem;">{% if product.image_prefix|add:'.jpg'|file_exists %}{% thumbnail product.image_prefix|add:'.jpg' '160x160' padding=True as im %}<img src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}" alt="{{ product.title }} {{ product.whatis }}"/>{% endthumbnail %}{% else %}<i class="d-inline-block czi-camera text-muted" style="width: 160px; height: 160px; font-size: 80px; padding: 40px"></i>{% endif %}</a>
                <div class="media-body pt-2">
                  <h3 class="product-title font-size-base mb-2"><a href="{% url 'product' product.code %}">{{ product.title }}</a></h3>
                  <div class="font-size-lg text-accent pt-2">{{ product.price }}</span><small>&nbsp;руб</small></div>
                </div>
              </div>
              <div class="pt-2 pt-sm-3 mx-auto mx-sm-0 text-center">
                {% if product.instock > 0 %}
                <a class="btn btn-primary btn-sm add-to-cart" href="{% url 'shop:add' product.id %}" data-id="{{ product.id }}"><span class="d-none spinner-border spinner-border-sm mr-2" role="status" aria-hidden="true"></span><i class="czi-cart font-size-sm mr-1"></i>{% if product.variations %}Выбрать{% else %}Купить{% endif %}</a>
                {% endif %}
                <a class="btn btn-outline-danger btn-sm unfavoritize" href="{% url 'shop:unfavoritize' product.id %}" data-id="{{ product.id }}"><i class="czi-trash mr-2"></i>Удалить</a>
              </div>
            </div>
            {% endfor %}
          </div>
          <div class="font-size-lg{% if favorites %} d-none{% endif %}" id="empty-message">Здесь появятся ваши избранные товары</div>
{% endblock %}
{% block javascript %}
<script type="text/javascript">
(function() {
    'use strict';

    var removers = document.getElementsByClassName("unfavoritize");
    for (var i = 0; i < removers.length; i++) {
        removers[i].addEventListener("click", function(event) {
            event.preventDefault();
            var xhr = new XMLHttpRequest();
            xhr.onload = function () {
                        var data = JSON.parse(xhr.responseText);
                        console.log(data.count);
                var parent = sworld.getParentByClassName(event.target, 'favorites-item');
                parent.addEventListener('transitionend', function() {
                    var prev = parent.previousElementSibling;
                    var next = parent.nextElementSibling;

                    if (prev === null) { // we are removing first element
                        if (next != null) {
                            next.classList.remove('my-4');
                            next.classList.add('mt-lg-4', 'mb-4');
                        }
                    }
                    if (next === null) { // we are removing last element
                        if (prev != null) {
                            prev.classList.remove('pb-3', 'pb-sm-2', 'border-bottom');
                        }
                    }

                    if (next === null && prev === null) {
                        document.getElementById('empty-message').classList.remove('d-none');
                    }

                    parent.parentNode.removeChild(parent);
                });
                parent.classList.add('fade');
                shop.reloadFavoritesNotice();
                document.getElementById('sw-favorites-count').textContent=data.count;
            };
            xhr.open('GET', event.target.href + "?ajax=1");
            xhr.send();
        });
    }
})();
</script>
{% endblock %}

