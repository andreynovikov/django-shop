{% extends "page_overlapped.html" %}
{% load staticfiles %}
{% load thumbnail %}
{% load site %}
{% load decimals %}
{% load rupluralize %}
{% load render_as_template %}
{% load shop_filters %}
{% load reviews %}
{% block link %}
{% if request.META.QUERY_STRING %}
    <link rel="canonical" href="https://www.sewing-world.ru{% url 'product' product.code %}" />
{% endif %}
{% endblock link %}
{% block title %}{{ product.title }}{% endblock %}
{% block content_title %}{{ product.title }}{% endblock %}
{% block content_title_addon %}
{% if product.allow_reviews %}
{% get_rating for product as product_rating %}
{% if product_rating %}
          <div>
            <div class="star-rating">
              <a href="#reviews" data-scroll>{% render_rating_value product_rating %}<span class="d-inline-block font-size-sm text-white opacity-70 align-middle mt-1 ml-1">{% get_review_count for product as review_count %}{{ review_count }} {{ review_count|rupluralize:"обзор,обзора,обзоров"}}</span></a>
            </div>
          </div>
{% endif %}
{% endif %}
{% endblock content_title_addon %}
{% block content %}
    <div class="container">
      <div class="bg-light box-shadow-lg rounded-lg px-4 py-3 mb-5">
        <div class="px-lg-3">
          <div class="row">
            <div class="col-lg-7 pr-lg-0">
              {% if product.image_prefix|add:'.jpg'|file_exists %}
              <!-- Product gallery-->
              <div class="cz-product-gallery d-block">{# added d-block #}
                <div class="cz-preview ml-0">{# added ml-0, removed order-sm-2 #}
                  <div class="cz-preview-item active" id="preview0"><img class="cz-image-zoom" src="{{ MEDIA_URL }}{{ product.image_prefix }}.jpg" alt="{{ product.title }} {{ product.whatis }}" itemprop="image" data-zoom="{{ MEDIA_URL }}{{ product.image_prefix }}{% if product.image_prefix|add:'.b.jpg'|file_exists %}.b{% endif %}.jpg">
                    <div class="cz-image-zoom-pane"></div>
                  </div>
                  {% for image in product.images %}
                  <div class="cz-preview-item" id="preview{{ forloop.counter }}"><img class="cz-image-zoom" src="{{ MEDIA_URL }}{{ product.image_prefix }}/{{image}}.jpg" data-zoom="{{ MEDIA_URL }}{{ product.image_prefix }}/{{image}}.jpg" alt="{{ product.title }} - фото №{{ forloop.counter }}">
                    <div class="cz-image-zoom-pane"></div>
                  </div>
                  {% endfor %}
                </div>
                {% for image in product.images %}
                {% if forloop.first %}
                <div class="cz-thumblist d-flex flex-wrap">{# added d-flex flex-wrap, removed order-sm-1 #}<a class="cz-thumblist-item active" href="#preview0">{% thumbnail product.image_prefix|add:'.jpg' '80x80' padding=True as im %}<img src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}" alt="Product thumb">{% endthumbnail %}</a>
                {% endif %}
                    <a class="cz-thumblist-item" href="#preview{{ forloop.counter }}">{% thumbnail product.image_prefix|add:'/'|add:image|add:'.jpg' '80x80' padding=True as im %}<img src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}" alt="Product thumb"/>{% endthumbnail %}</a>
                {% if forloop.last %}
                </div>
                {% endif %}
                {% endfor %}
              </div>
              {% else %}
              <div class="d-none d-lg-block"><i class="czi-camera text-muted d-block mx-auto" style="width: 300px; font-size: 300px"></i></div>
              {% endif %}
            </div>
            <!-- Product details-->
            <div class="col-lg-5 pt-4 pt-lg-0">
              <div class="product-details ml-auto pb-3">
                {% if product.enabled and product.cost > 0 %}
                <div class="d-flex flex-row align-items-baseline mb-3">
                  <div><span class="h3 font-weight-normal text-accent mr-1" itemprop="price">{{ product.cost|quantize:"1" }}<small>&nbsp;руб</small></span><span itemprop="priceCurrency" class="d-none">RUB</span>{% if product.discount > 0 %}<del class="text-muted font-size-lg">{{ product.price|quantize:"1" }}<small>&nbsp;руб</small></del>{% endif %}</div>
                  <div class="ml-3">
                    {% if product.discount > 0 %}
                    <span class="badge badge-primary badge-shadow align-middle mt-n2" data-toggle="tooltip" data-placement="right" data-html="true" title="Базовая цена в магазинах &laquo;Швейный Мир&raquo; без учета скидок <b>{{ product.price|quantize:"1" }}</b>&nbsp;руб. Скидка при покупке в интернет-магазине составляет <b>{{ product.discount|quantize:"1" }}</b>&nbsp;руб.">Скидка</span>
                    {% endif %}
                    {% if product.ishot %}
                    <span class="badge badge-accent badge-shadow align-middle mt-n2">Акция</span>
                    {% endif %}
                    {% if product.isnew %}
                    <span class="badge badge-info badge-shadow align-middle mt-n2">Новинка</span>
                    {% endif %}
                    {% if product.recomended %}
                    <span class="badge badge-warning badge-shadow align-middle mt-n2">Рекомендуем</span>
                    {% endif %}
                  </div>
                </div>
                {% endif %}{# enabled and cost > 0 #}
                {% if product.runame or product.whatis %}
                <div class="font-size-sm mb-4"><span class="text-muted font-weight-medium mr-1">{{ product.whatis }} {{ product.runame }}</span></div>
                {% endif %}
                <div class="position-relative mr-n4">
                  <div class="product-badge product-{% if product.instock < 1 %}not-{% endif %}available mt-1"><i class="czi-security-{% if product.instock > 1 %}check{% elif product.instock == 1 %}announcement{% else %}close{% endif %}"></i>{% if product.enabled %}{% if product.instock > 1 %}В наличии{% elif product.instock == 1 %}Осталось мало{% else %}Закончились{% endif %}{% else %}Товар снят с продажи{% endif %}</div>
                </div>
                {% if product.enabled %}
                <div class="mr-2"><div class="mr-5 pb-4 pr-5 font-size-sm">
                  {% for action in product.get_sales_actions %}{% if action.brief %}
                  <div class="mb-2"><i class="czi-gift text-danger pr-2"></i>{% render_as_template action.brief %}</div>
                  {% endif %}{% endfor %}
                  {% if product.state %}
                  <div class="mb-2"><i class="czi-message text-danger pr-2"></i>{{ product.state }}</div>
                  {% endif %}
                  {% if product.sales_notes %}
                  <div class="mb-2"><i class="czi-announcement text-danger pr-2"></i>{{ product.sales_notes }}</div>
                  {% endif %}
                  {% if product.utilisation %}
                  <div class="mb-2"><i class="czi-gift text-danger pr-2"></i>Участник акции <a href="/actions/utilisation.html">"Утилизация"</a>! Скидка по акции <span class="price">{{ product.maxdiscount }}%</span>!</div>
                  {% endif %}
                </div></div>
                {% if product.cost > 0 %}
                <div class="d-flex align-items-center pt-2 pb-4" itemprop="offers" itemscope itemtype="http://schema.org/Offer">
                  {% if product.instock > 5 %}
                  <select class="custom-select mr-3 quantity-input" style="width: 5rem;">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                  </select>
                  {% endif %}
                  {% if product.instock > 0 %}
                  <a class="btn btn-primary btn-shadow btn-block add-to-cart" href="{% url 'shop:add' product.id %}{% if utm_source %}?utm_source={{ utm_source }}{% endif %}" data-id="{{ product.id }}"><span class="d-none spinner-border spinner-border-sm mr-2" role="status" aria-hidden="true"></span><i class="czi-cart font-size-lg mr-2"></i>Купить</a>
                  {% else %}
                  <a class="btn btn-primary btn-shadow btn-block add-to-cart" href="{% url 'shop:add' product.id %}{% if utm_source %}?utm_source={{ utm_source }}{% endif %}" data-id="{{ product.id }}"><span class="d-none spinner-border spinner-border-sm mr-2" role="status" aria-hidden="true"></span><i class="czi-delivery font-size-lg mr-2"></i>Сообщить о поступлении</a>
                  {% endif %}
                </div>
                {% endif %}
                {% else %}
                <div class="py-5"></div>
                {% endif %}{# enabled #}
                {% if product.enabled or product.kind.all %}
                <div class="d-flex mb-4">
                  {% if product.enabled %}
                  <div class="w-100">
                    <button class="btn btn-secondary btn-block" type="button"><i class="czi-heart font-size-lg mr-2"></i><span class='d-none d-sm-inline'>Add to </span>Wishlist</button>
                  </div>
                  {% endif %}
                  {% if product.kind.all %}
                  <div class="w-100 ml-3">
                    <a class="btn btn-{% if is_compared %}accent{% else %}secondary{% endif %} btn-block compare-product" data-id="{{ product.id }}"{% if not is_compared %} data-comparison-link="{% url 'compare_kind' product.kind.all.0.id %}"{% endif %} href="{% if is_compared %}{% url 'compare_kind' product.kind.all.0.id %}{% else %}{% url 'compare_product' product.code %}{% endif %}" rel="nofollow"><i class="czi-compare font-size-lg mr-2"></i><span>{% if is_compared %}Сравнение{% else %}Сравнить{% endif %}</span></a>
                  </div>
                  {% endif %}
                </div>
                {% endif %}{# enabled or comparable #}
                <!-- Product panels-->
                <div class="accordion mb-4" id="productPanels">
                  <div class="card">
                    <div class="card-header">
                      <h3 class="accordion-heading"><a href="#information" role="button" data-toggle="collapse" aria-expanded="true" aria-controls="information"><i class="czi-lable text-muted lead align-middle mt-n1 mr-2"></i>Информация<span class="accordion-indicator"><i data-feather="chevron-up"></i></span></a></h3>
                    </div>
                    <div class="collapse show" id="information" data-parent="#productPanels">
                      <div class="card-body font-size-sm">
                        {% if product.manufacturer %}
                        <div class="d-flex justify-content-between pb-2">
                          <div class="text-muted">Производитель</div>
                          <div class="font-weight-semibold">{{ product.manufacturer.name }}</div>
                        </div>
                        {% endif %}
                        {% if product.partnumber %}
                        <div class="d-flex justify-content-between pb-2">
                          <div class="text-muted">Артикул</div>
                          <div class="font-weight-semibold">{{ product.partnumber }}</div>
                        </div>
                        {% endif %}
                        {% if product.developer_country and product.developer_country.enabled %}
                        <div class="d-flex justify-content-between pb-2">
                          <div class="text-muted">Страна разработки</div>
                          <div class="font-weight-semibold">{{ product.developer_country }}</div>
                        </div>
                        {% endif %}
                        {% if product.country and product.country.enabled %}
                        <div class="d-flex justify-content-between pb-2">
                          <div class="text-muted">Страна производства</div>
                          <div class="font-weight-semibold">{{ product.country }}</div>
                        </div>
                        {% endif %}
                        {% if product.warranty %}
                        <div class="d-flex justify-content-between pb-2">
                          <div class="text-muted">Гарантия</div>
                          <div class="font-weight-semibold">{{ product.warranty }}</div>
                        </div>
                        {% endif %}
                        {% if product.article %}
                        <div class="d-flex justify-content-between pb-2">
                          <div class="text-muted">Код товара</div>
                          <div class="font-weight-semibold">{{ product.article }}</div>
                        </div>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  {% if product.enabled and product.cost > 0 %}
                  <div class="card">
                    <div class="card-header">
                      <h3 class="accordion-heading"><a class="collapsed" href="#localStore" role="button" data-toggle="collapse" aria-expanded="true" aria-controls="localStore"><i class="czi-location text-muted font-size-lg align-middle mt-n1 mr-2"></i>Наличие в магазинах<span class="accordion-indicator"><i data-feather="chevron-up"></i></span></a></h3>
                    </div>
                    <div class="collapse" id="localStore" data-parent="#productPanels">
                      <div class="card-body">
                        <div class="text-center"><div class="spinner-border" role="status"><span class="sr-only">Загрузка...</span></div></div>
                      </div>
                    </div>
                  </div>
                  {% endif %}
                  {% if product.manuals %}
                  <div class="card">
                    <div class="card-header">
                      <h3 class="accordion-heading"><a class="collapsed" href="#instructions" role="button" data-toggle="collapse" aria-expanded="true" aria-controls="instructions"><i class="czi-clip text-muted font-size-lg align-middle mt-n1 mr-2"></i>Инструкции<span class="accordion-indicator"><i data-feather="chevron-up"></i></span></a></h3>
                    </div>
                    <div class="collapse" id="instructions" data-parent="#productPanels">
                      <div class="card-body font-size-sm">
                        {{ product.manuals|safe }}
                      </div>
                    </div>
                  </div>
                  {% endif %}
                </div>

                {% if product.enabled %}
                {% with product as parent %}
                {% for product in gifts %}
                {% if forloop.first %}
                <div class="mb-1">Покупая {{ parent.title }} в интернет-магазине, Вы получите подарок:</div>
                <div class="mb-4 mx-auto w-75">
                {% endif %}
                  {% include "_product_card.html" %}
                {% if forloop.last %}
                </div>
                {% endif %}
                {% endfor %}
                {% endwith %}
                {% endif %}{# enabled #}

                <!-- Sharing-->
                <h6 class="d-inline-block align-middle font-size-base my-2 mr-2">Share:</h6><a class="share-btn sb-twitter mr-2 my-2" href="#"><i class="czi-twitter"></i>Twitter</a><a class="share-btn sb-instagram mr-2 my-2" href="#"><i class="czi-instagram"></i>Instagram</a><a class="share-btn sb-facebook my-2" href="#"><i class="czi-facebook"></i>Facebook</a>
              </div>
            </div>
          </div>
        </div>
      </div>

      {% if constituents %}
      <!-- Constituents -->
      <div class="pt-lg-2 pb-3 mb-md-3">
        <h2 class="h3 pb-2">Состав комплекта</h2>
        <div class="container px-0">
        {% for item in constituents %}
        {% with item.constituent as product %}
        <figure class="figure align-top" style="max-width: 242px">
          {% if product.image_prefix|add:'.jpg'|file_exists %}{% thumbnail product.image_prefix|add:'.jpg' '224x224' padding=True as im %}<img src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}" alt="{{ product.title }} {{ product.whatis }}" class="figure-img"/>{% endthumbnail %}{% else %}<i class="d-inline-block czi-camera text-muted figure-img" style="width: 224px; height: 224px; font-size: 100px; padding: 62px"></i>{% endif %}
          <figcaption class="figure-caption"><strong><a href="{% url 'product' product.code %}" class="text-muted">{{ product.title }}</a>{% if item.quantity > 1 %} ({{ item.quantity }} шт.){% endif %}</strong>{% if product.shortdescr %} &mdash; {{ product.shortdescr|safe }}{% endif %}</figcaption>
        </figure>
        {% endwith %}
        {% endfor %}
        </div>
      </div>
      {% endif %}

      {% if product.descr %}
      <div class="pb-3 mb-md-3" itemprop="description">{{ product.descr|safe }}</div>
      {% endif %}

      {% if product.spec %}
      <div class="pb-3 mb-md-3">{{ product.spec|safe }}</div>
      {% endif %}

      {% with 'fabric_verylite km_class km_font km_needles km_prog km_rapport sw_hoopsize sw_datalink sm_software sm_shuttletype sm_stitchwidth sm_stitchlenght sm_maxi sm_stitchquantity sm_buttonhole sm_alphabet sm_dualtransporter sm_platformlenght sm_freearm sm_feedwidth sm_footheight sm_constant sm_speedcontrol sm_needleupdown sm_threader sm_autocutter sm_spool sm_presscontrol sm_power sm_light sm_organizer sm_autostop sm_ruler sm_wastebin sm_cover sm_display sm_advisor sm_memory sm_mirror sm_startstop sm_kneelift sm_diffeed sm_easythreading ov_freearm sm_needles prom_transporter_type prom_shuttle_type prom_speed prom_needle_type prom_stitch_lenght prom_foot_lift prom_fabric_type prom_oil_type weight prom_weight prom_cutting prom_threads_num prom_power prom_bhlenght prom_overstitch_lenght prom_overstitch_width prom_stitch_width prom_needle_width prom_needle_num prom_platform_type prom_button_diaouter prom_button_diainner prom_needle_height prom_stitch_type prom_autothread' as field_list %}
      {% for field, field_value in field_list.split|fields_with_values:product %}
      {% if forloop.first %}
      <!-- Specs -->
      <div class="pt-lg-2 pb-3 mb-md-3">
        <h2 class="h3 pb-2">Характеристики {{ product.title }}</h2>
        <div class="product-spec container font-size-sm">
      {% endif %}
      {% if field == 'fabric_verylite' %}
          <div class="row mb-2"><span class="col-md px-0 text-muted"><span class="d-block border-bottom"><span>Диапазон прошиваемых материалов <a class="opener-html" href="/blog/H/"><i class="czi-message font-size-ms text-muted"></i></a></span></span></span><span class="col-md pt-1 pt-sm-0 pr-0 pl-2 align-self-end">Очень легкие – {{ product.fabric_verylite }}<br>Легкие – {{ product.fabric_lite }}<br>Средние и умеренно тяжелые – {{ product.fabric_medium }}<br>Тяжелые – {{ product.fabric_hard }}<br>Трикотаж – {{ product.fabric_stretch }}</span></div>
      {% else %}
      {% with field_name=product|get_field_name:field|parse_field_name %}
          <div class="row mb-2"><span class="col-md px-0 text-muted"><span class="d-block border-bottom"><span>{{ field_name.0 }}{% include '_field_help.html' %}</span></span></span><span class="col-md pt-1 pt-sm-0 pr-0 pl-2 align-self-end">{{ field_value|prettify }}{{ field_name.1 }}</span></div>
      {% endwith %}
      {% endif %}
      {% if forloop.last %}
        </div>
      </div>
      {% endif %}
      {% endfor %}
      {% endwith %}

      {% if 'images/'|add:product.manufacturer.code|add:'/stitches/'|add:product.code|add:'_stitches.jpg'|file_exists or product.stitches %}
      <!-- Stitches -->
      <div class="pt-lg-2 pb-3 mb-md-3">
        <h2 class="h3 pb-2">Строчки {{ product.title }}</h2>
        {% if 'images/'|add:product.manufacturer.code|add:'/stitches/'|add:product.code|add:'_stitches.jpg'|file_exists %}
        <div class="pb-3 mb-md-3">
          <img src="{{ MEDIA_URL }}/images/{{ product.manufacturer.code }}/stitches/{{ product.code }}_stitches.jpg" alt="Строчки швейной машины {{ product.title }}" class="img-responsive">
        </div>
        {% endif %}
        {% if product.stitches %}
        <div>
          {{ product.stitches|safe }}
        </div>
        {% endif %}
      </div>
      {% endif %}

      {% if product.complect %}
      <div class="pt-lg-2 pb-3 mb-md-3">
        <h2 class="h3 pb-2">Комплектация</h2>
        <div>{{ product.complect|safe }}</div>
      </div>
      {% endif %}

    </div>

    {% if accessories or similar %}
    <hr class="pb-5">
    {% with product as parent %}
    {% for product in accessories %}
    {% if forloop.first %}
    <!-- Product carousel (accessories) -->
    <div class="container pt-lg-2 pb-5 mb-md-3">
      <h2 class="h3 text-center pb-4">Популярные аксессуары для {{ parent.title }}</h2>
      <div class="cz-carousel cz-controls-static cz-controls-outside">
        <div class="cz-carousel-inner" data-carousel-options="{&quot;items&quot;: 2, &quot;controls&quot;: true, &quot;nav&quot;: false, &quot;autoHeight&quot;: true, &quot;responsive&quot;: {&quot;0&quot;:{&quot;items&quot;:1},&quot;500&quot;:{&quot;items&quot;:2, &quot;gutter&quot;: 18},&quot;768&quot;:{&quot;items&quot;:3, &quot;gutter&quot;: 20}, &quot;1100&quot;:{&quot;items&quot;:4, &quot;gutter&quot;: 30}}}">
    {% endif %}
          <div>
            {% include "_product_card.html" %}
          </div>
    {% if forloop.last %}
        </div>
      </div>
    </div>
    {% endif %}
    {% endfor %}
    {% for product in similar %}
    {% if forloop.first %}
    <!-- Product carousel (similar) -->
    <div class="container pt-lg-2 pb-5 mb-md-3">
      <h2 class="h3 text-center pb-4">Товары похожие на {{ parent.title }}</h2>
      <div class="cz-carousel cz-controls-static cz-controls-outside">
        <div class="cz-carousel-inner" data-carousel-options="{&quot;items&quot;: 2, &quot;controls&quot;: true, &quot;nav&quot;: false, &quot;autoHeight&quot;: true, &quot;responsive&quot;: {&quot;0&quot;:{&quot;items&quot;:1},&quot;500&quot;:{&quot;items&quot;:2, &quot;gutter&quot;: 18},&quot;768&quot;:{&quot;items&quot;:3, &quot;gutter&quot;: 20}, &quot;1100&quot;:{&quot;items&quot;:4, &quot;gutter&quot;: 30}}}">
    {% endif %}
          <div>
            {% include "_product_card.html" %}
          </div>
    {% if forloop.last %}
        </div>
      </div>
    </div>
    {% endif %}
    {% endfor %}
    {% endwith %}
    {% endif %}

    {% if product.dealertxt %}
    <hr class="pb-5">
    <div class="container pt-lg-2 pb-5 mb-md-3">
      <h2 class="h3 text-center pb-4">Обратите внимание!</h2>
      <div>{{ product.dealertxt }}</div>
    </div>
    {% endif %}

    {% if product.allow_reviews %}
    {% include '_product_reviews.html' %}
    {% endif %}
{% endblock content %}
{% block javascript %}
<script>
    $('#productPanels').on('show.bs.collapse', function(e) {
        if ($(e.target).has('.spinner-border').length == 0)
            return;
        var itemId = $(e.target).attr('id');
        if (itemId == 'localStore')
            $(e.target).find('.card-body').load('{% url 'product_stock' product.code %}', function(){});
    });
</script>
{% endblock %}
