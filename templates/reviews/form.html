{% load reviews %}
{% load widget_tweaks %}
{% if not request.user.username %}
<div class="modal" tabindex="-1" role="dialog" id="sw-user-update-modal">
    <div class="modal-dialog" role="document">
        <form id="sw-update-user-form" class="modal-content needs-validation{% if invalid %} was-validated{% endif %}" method="post" novalidate action="{% url 'shop:profile' %}">
            <div class="modal-body">
                <div class="text-center">
                    <div class="spinner-border" role="status"><span class="visually-hidden">Загрузка...</span></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Закрыть</button>
                <button type="submit" class="btn btn-primary btn-sm">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<div class="alert alert-warning d-flex" role="alert" id="sw-user-update-warning">
    <div class="alert-icon">
        <i class="ci-announcement"></i>
    </div>
    <div>Вы можете <a class="alert-link" id="sw-user-update-link" data-bs-toggle="modal" href="#" data-bs-target="#sw-user-update-modal">указать</a> псевдоним, если не хотите, чтобы отображалось Ваше реальное имя.</div>
</div>
{% endif %}
<form class="needs-validation" method="post" novalidate action="{% review_form_target %}">{% csrf_token %}
  {% if next %}
    <input type="hidden" name="next" value="{{ next }}"/>
  {% endif %}
  {% for field in form %}
    {% if field.is_hidden %}
      {{ field }}
    {% else %}
      <div class="mb-3{% if field.errors %} error{% endif %}"{% ifequal field.name "honeypot" %} style="display:none;"{% endifequal %}>
        <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}{% if field.field.required %}<span class="text-danger">*</span>{% endif %}</label>
        {% render_field field class="form-control" %}
        <div class="invalid-feedback">Необходимо заполнить поле!</div>
        {% if field.errors %}<div class="text-danger">{{ field.errors }}</div>{% endif %}
      </div>
    {% endif %}
  {% endfor %}
  <button class="btn btn-primary btn-shadow d-block" type="submit">Опубликовать отзыв</button>
</form>

<script>
(function () {
    'use strict';

    var addFormSumbitListener = function() {
        var form = document.getElementById('id_phone').form;
        form.addEventListener('submit', function(event) {
            var data = sworld.serializeForm(form) + '&ajax=1';
            var xhr = new XMLHttpRequest();
            xhr.onload = function() {
                if (xhr.status >= 200 && xhr.status < 400) {
                    var data = xhr.response;
                    var modal = document.getElementById('sw-user-update-modal');
                    modal.querySelector('.modal-body').innerHTML = data.html;
                    addFormSumbitListener();
                }
            };
            xhr.open('POST', form.action, true);
            xhr.send(data);
            event.preventDefault();
            event.stopPropagation();
        }, false);

        if (form.checkValidity() && form.username.value) {
            var modalEl = document.getElementById('sw-user-update-modal');
            var modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.hide();
            var warning = document.getElementById('sw-user-update-warning');
            warning.classList.add('d-none');
        }
    };

    document.addEventListener('DOMContentLoaded', function() {
        var modal = document.getElementById('sw-user-update-modal');
        modal.addEventListener('show.bs.modal', function(e) {
            if (!document.getElementById('id_phone')) {
                var xhr = new XMLHttpRequest();
                xhr.responseType = 'json';
                xhr.onload = function() {
                    if (xhr.status >= 200 && xhr.status < 400) {
                        var data = xhr.response;
                        modal.querySelector('.modal-body').innerHTML = data.html;
                        addFormSumbitListener();
                    }
                };
                xhr.open('GET', '{% url 'shop:profile' %}?ajax=1', true);
                xhr.send();
            }
        });
    });
}());
</script>
