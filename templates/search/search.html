{% extends 'base.html' %}
{% load staticfiles %}
{% load widget_tweaks %}
{% block title %}
Поиск
{% endblock %}
{% block search_form %}{% endblock %}
{% block content %}
<div id="subheadwrap">
  <div id="subhead">
    <h1>Поиск</h1>
  </div><!-- End subhead -->
</div><!-- End subheadwrap -->

<form method="get" class="form-inline" id="searchForm" action=".">
    {% for field in form %}
        <div class="form-group{% if field.errors %} has-feedback has-error{% endif %}">
        {% render_field field class="form-control" autocomplete="off" size="70" %}
        {% if field.errors %}
            {% for error in field.errors %}
                <span class="help-block">{{ error }}</span>
            {% endfor %}
        {% endif %}
        </div>
    {% endfor %}
<button type="submit" class="btn btn-default">Найти</button>
</form>

{% if query %}
<div id="list_results">
{% for result, cost, quantity in page.object_list %}
{% with result.object as product %}
{% include "_product_info.html" %}
{% endwith %}
{% empty %}
<p>Ничего не найдено.</p>
{% endfor %}
</div>
<div class="clear"></div>

{% if page.has_previous or page.has_next %}
<div>
    {% if page.has_previous %}<a href="?q={{ query }}&amp;page={{ page.previous_page_number }}">{% endif %}&laquo; Previous{% if page.has_previous %}</a>{% endif %}
    |
    {% if page.has_next %}<a href="?q={{ query }}&amp;page={{ page.next_page_number }}">{% endif %}Next &raquo;{% if page.has_next %}</a>{% endif %}
</div>
{% endif %}
{% else %}
{# Show some example queries to run, maybe query syntax, something else? #}
{% endif %}
{% endblock content %}
{% block javascript %}
<script src="{% static 'js/jquery.spinner.js' %}"></script>
<script>
$(document).ready(function () {

    var CustomHandlers = function () {
    };
    CustomHandlers.prototype.addAjaxFlag = function (e, $el) {
        $el.on("eldarion-ajax:modify-data", function (e, data) {
            if (typeof data === "object") // using FormData
                data.append("ajax", 1);
            else if (data != null)
                data = data + "&ajax=1";
            else
                data = "ajax=1";
            return data;
        });
    };
    CustomHandlers.prototype.setQuantityWarning = function (e, $el) {
        $el.find(".quantity-container").addClass("has-warning");
    };
    CustomHandlers.prototype.setQuantity = function (e, $el, data) {
        var $in = $el.find(".sw-basket-quantity");
        $in.val(data["quantity"]);
        var $cn = $el.find(".quantity-container");
        $cn.removeClass("has-warning").addClass("has-success");
        $in.on("blur", function () {
            $cn.removeClass("has-success");
        });
    };

    $(document).on("eldarion-ajax:begin", function(evt, $el) {
        $("body").css("cursor", "progress");
    });
    $(document).on("eldarion-ajax:complete", function(evt, $el) {
        $("body").css("cursor", "auto");
        updateCartNotice();
    });


    $(document).on("eldarion-ajax:begin",   ".ajax", CustomHandlers.prototype.addAjaxFlag);
    $(document).on("eldarion-ajax:begin",   ".update", CustomHandlers.prototype.setQuantityWarning);
    $(document).on("eldarion-ajax:success", ".update", CustomHandlers.prototype.setQuantity);


    $('[data-trigger="spinner"]').spinner('changed', function(e, newVal, oldVal) {
        var $form = $(this).closest("form");
        //console.error($form);
        //$.dump($form);
        $form.submit();
        //return false;
        //alert("{{ product.id }} " + newVal);
        ym(51806498, 'reachGoal', 'tobasket');
    });

    $('.expand-description').each(function() {
        $(this).one("click", function() {
            var productID = this.href.split("descr_")[1];
            var url="/catalog/expand/"+productID+"/";
            $('#descr_'+productID).load(url);
        });
    });
});
</script>
{% endblock %}
