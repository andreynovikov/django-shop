{% load spirit_tags i18n %}

{% for c in comments %}
<div class="media p{% if forloop.first %}b{% else %}y{% endif %}-4 border-bottom comment{% if c.action %} text-info{% endif %}" id="c{{forloop.counter0|add:comments.start_index }}" data-number="{{ forloop.counter0|add:comments.start_index }}" data-pk="{{ c.pk }}">
    {% if not c.is_removed %}
    <img class="rounded-circle" width="50" src="{% get_gravatar_url user=c.user size=50 %}" alt="{{ c.user.get_full_name }}">
    <div class="media-body pl-3">
        <h6 class="font-size-md mb-2{% if c.user.st.is_administrator %} text-danger{% elif c.user.st.is_moderator %} text-accent{% endif %}">{% if user.is_authenticated and user.st.is_moderator %}<a class="username" href="{{ c.user.st.get_absolute_url }}">{% endif %}{{ c.user.get_full_name }}{% if user.is_authenticated and user.st.is_moderator %}</a>{% endif %}</h6>
        <div class="font-size-md mb-1">
            {% if not c.action %}
            {% post_render_comment comment=c %}
            {% else %}
            {% get_comment_action_text c.action %}.
            {% endif %}
        </div>
        <span class="font-size-ms text-muted" title="{{ c.date }}"><i class="czi-time align-middle mr-2"></i>{{ c.date|shortnaturaltime }}</span>
        {% if c.modified_count > 0 %}
        <a class="font-size-ms text-muted ml-3" href="{% url "spirit:comment:history:detail" comment_id=c.pk %}"><i class="czi-edit-alt align-middle mr-2"></i>{{ c.modified_count }}</a>
        {% endif %}

        {% if not c.action %}
        <ul class="list-inline d-inline-block font-size-ms float-right">
        <li class="list-inline-item"><a class="text-muted" href="#" data-toggle="modal" data-target="#modal-share-{{ c.pk }}"><i class="czi-share-alt align-middle mr-1"></i>{% trans "share" %}</a></li>

        {% if user.is_authenticated %}
        <li class="list-inline-item"><a class="text-muted" href="{% url "spirit:comment:flag:create" c.pk %}"><i class="czi-flag align-middle mr-1"></i>{% trans "report" %}</a></li>
        {% if c.like %}
        <li class="list-inline-item comment-like"><a class="js-like text-muted" href="{% url "spirit:comment:like:delete" c.like.pk %}" data-count="{{ c.likes_count }}" ><i class="czi-heart align-middle mr-1"></i>{% trans "remove like" %} ({{ c.likes_count }})</a></li>
        {% else %}
        {% ifnotequal c.user user %}
        <li class="list-inline-item comment-like"><a class="js-like like text-muted" href="{% url "spirit:comment:like:create" c.pk %}" data-count="{{ c.likes_count }}" ><i class="czi-heart align-middle mr-1"></i>{% trans "like" %} ({{ c.likes_count }})</a></li>
        {% else %}
        <li class="list-inline-item comment-like"><i class="czi-heart align-middle mr-1"></i>({{ c.likes_count }})</li>
        {% endifnotequal %}
        {% endif %}

        {% if user.st.is_moderator or c.user.pk == user.pk %}
        <li class="list-inline-item"><a class="text-muted" href="{% url "spirit:comment:update" pk=c.pk %}"><i class="czi-edit align-middle mr-1"></i>{% trans "edit" %}</a></li>
        {% endif %}

        {% ifnotequal c.user.pk user.pk %}
        <li class="list-inline-item"><a class="text-muted" href="{% url "spirit:comment:publish" topic_id=topic.pk pk=c.pk %}"><i class="czi-message align-middle mr-1"></i>{% trans "quote" %}</a></li>
        <li class="list-inline-item"><a class="text-muted" href="#reply"><i class="czi-reply align-middle mr-1"></i>{% trans "reply" %}</a></li>
        {% endifnotequal %}

        {% if user.st.is_moderator %}
        <li class="list-inline-item comment-date"><a class="text-muted" href="{% url "spirit:comment:delete" c.pk %}"><i class="czi-close-circle align-middle mr-1"></i>{% trans "delete" %}</a></li>
        {% endif %}
        {% endif %}
        </ul>

        <div class="modal fade" id="modal-share-{{ c.pk }}" tabindex="-1" role="dialog" aria-labelledby="modal-share-{{ c.pk }}-title" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modal-share-{{ c.pk }}-title">Поделиться</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        {% with comment_url=c.get_absolute_url %}
                        <input class="form-control" type="text" value="{% get_share_url url=comment_url %}" />
                        <ul class="list-inline mt-2">
                            <li class="list-inline-item"><a class="text-dark" href="{% get_twitter_share_url url=comment_url title=topic.title %}" target="_blank"><i class="czi-twitter"></i></a></li>
                            <li class="list-inline-item"><a class="text-dark" href="{% get_facebook_share_url url=comment_url title=topic.title %}" target="_blank"><i class="czi-facebook"></i></a></li>
                            <li class="list-inline-item"><a class="text-dark" href="{% get_email_share_url url=comment_url title=topic.title %}" ><i class="czi-mail"></i></a></li>
                        </ul>
                        {% endwith %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% else %}
    <div class="media-body pl-3" style="margin-left: 50px">
        <div class="font-size-sm mb-1 text-muted">
            {% if user.st.is_moderator %}
            {{ c.comment_html|safe }}
            {% else %}
            {% trans "This comment was deleted" %}.
            {% endif %}
        </div>
        {% if user.st.is_moderator %}
        <ul class="list-inline d-inline-block font-size-ms float-right">
        <li class="list-inline-item"><a class="text-muted" href="{% url "spirit:comment:undelete" c.pk %}"><i class="czi-close-circle align-middle mr-1"></i>{% trans "undelete" %}</a></li>
        </ul>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endfor %}

<script>

    document.addEventListener('DOMContentLoaded', function() {

        {% if user.is_authenticated %}
            stModules.like(document.querySelectorAll('.js-like'), {
                csrfToken: "{{ csrf_token }}",
                likeText: "<span class=\"fa fa-heart\"></span> " + "{% trans "like" %} ({count})",
                removeLikeText: "<span class=\"fa fa-heart\"></span> " + "{% trans "remove like" %} ({count})"
            });
        {% endif %}

        hljs.initHighlightingOnLoad();

    });

</script>
